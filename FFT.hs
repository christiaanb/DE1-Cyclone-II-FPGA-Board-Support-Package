module FFT where

import Control.Arrow ((>>>))
import CLaSH.Prelude
import CLaSH.Prelude.Explicit
import DE1Types
import Utils


type Binaddr = Unsigned 7
type Samplnr = Unsigned 8

data Switch = Straight | Crossed deriving (Eq,Show)

invert :: Switch -> Switch
invert sw = if sw == Straight
            then Crossed
            else Straight

cadd :: CWord -> CWord -> CWord
cadd (ar,ai) (br,bi) = ( rout, iout )
  where routi = ((resize ar) + (resize br))  :: (Signed 19)
        iouti = ((resize ai) + (resize bi)) :: (Signed 19)
        rout  = resize (routi `shiftR` 1) :: FWord
        iout  = resize (iouti `shiftR` 1) :: FWord

csub :: CWord -> CWord -> CWord
csub (ar,ai) (br,bi) = (rout, iout)
  where routi = ((resize ar) - (resize br)) :: (Signed 19)
        iouti = ((resize ai) - (resize bi)) :: (Signed 19)
        rout  = resize (routi `shiftR` 1) :: FWord
        iout  = resize (iouti `shiftR` 1) :: FWord

cmult :: CWord -> CFPConst -> CWord
cmult (r1, i1) (r2, i2) = ( (fpmult r1 r2) - (fpmult i1 i2), (fpmult r1 i2) + (fpmult i1 r2) )

fpmult :: FWord -> FPConst -> FWord
fpmult i (cf,cs) = o
  where vi = (resize i) :: DWord
        vc = (resize cf) :: DWord
        o = (resize (shiftR (vi * vc) ((fromIntegral cs) ))) :: FWord

fpbfly :: (CWord, CWord) -> CFPConst -> (CWord, CWord)
fpbfly (xt, xb) twfact = (yt, yb)
  where xbw = cmult xb twfact
        (yt, yb) = (cadd xt xbw, csub xt xbw)


butterfly ((twfactors, cntrmax, cntr)) (valid, int, inb) = ((twfactors, cntrmax, cntrn), (valid, outt, outb))
  where (outt, outb) = fpbfly (int, inb) (twfactors !! cntr) -- first find the intermedia output values
        cntrn = if valid
                then
                  if cntr == cntrmax
                  then 0
                  else cntr + 1
                else cntr

commutator ((fifol, fifor, cntrmax, sw, cntr)) (valid, int, inb) = ((fifoln, fiforn, cntrmax, swn, cntrn), (valid, outt, outb))
  where (outt, outb) = (last fifor, swob )
        (swot, swob) = if sw == Straight
                       then (int, last fifol)
                       else (last fifol, int)
        (fifoln, fiforn) = if valid
                           then (inb +>> fifol, swot +>> fifor)
                           else (fifol, fifor)
        swn = if (cntr == cntrmax) && valid
              then invert sw
              else sw
        cntrn = if valid
                then
                  if cntr == cntrmax
                  then 0
                  else cntr + 1
                else cntr

-- The last stage of the FFT pipeline: this stages calculates the magnitude squared and generates the addresses correcsponding to the freq bin number
magsqrdaddr :: ((Samplnr, Bool)) -> (Bool, CWord, CWord) -> ((Samplnr, Bool), (FWord, Binaddr, Bool))
magsqrdaddr ((cntr, initDone)) (valid, int, _) = ((cntrn, initDonen), (res, addr, binvalid))
  where a = (resize (fst int)) :: DWord
        b = (resize (snd int)) :: DWord
        cntrn = if valid
                then cntr + 1
                else cntr
        (addr, binvalid) = if valid && (cntr <= 127) && initDone
                           then (bitrev (resize cntr), True)
                           else (0, False)
        initDonen = if (initDone == False) && (cntr <= 127)
                    then False
                    else True
        res = resize (shiftR (a*a + b*b) 18)

-- Sample the valid signal
valsampler :: (Bit) -> (FWord, Bit) -> (Bit, (Bool, CWord, CWord))
valsampler (svalid) (datain, validin) = (svalidn, (outvalid, outt, outb))
  where (outt, outb) = ((datain,0), (0,0))
        outvalid = ((complement svalid) .&. validin) == 1
        svalidn = validin

-- The register on the output
outreg :: ((FWord, Binaddr, Bool)) -> (FWord, Binaddr, Bool) -> ((FWord, Binaddr, Bool), (FWord, Binaddr, Bool))
outreg ((sdata, saddr, svalid))  (datain, addrin, validin) = ((sdatan, saddrn, svalidn), (dataout, addrout, validout))
  where (sdatan, saddrn, svalidn) = (datain, addrin, validin)
        (dataout, addrout, validout) = (sdata, saddr, svalid)

-- Initial state of stage 0
s0twfactors = $(v [
  ((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)) :: CFPConst  ])
s0butterflyL = mealy' fftClock butterfly (s0twfactors, 127, 0 :: Index 128)

s0fiflinitst, s0fifrinitst :: Vec 128 CWord
(s0fiflinitst,s0fifrinitst) = (replicate d128 (0,0), replicate d128 (0,0))
s0commutatorL = mealy' fftClock commutator (s0fiflinitst, s0fifrinitst, 127 :: Unsigned 7, Straight, 0 :: Unsigned 7)

-- Initial state of stage 1
s1twfactors = $(v [
  ((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)) :: CFPConst  ])
s1butterflyL = mealy' fftClock butterfly (s1twfactors, 127, 64 :: Index 128)

s1fiflinitst, s1fifrinitst :: Vec 64 CWord
(s1fiflinitst,s1fifrinitst) = (replicate d64 (0,0), replicate d64 (0,0))
s1commutatorL = mealy' fftClock commutator (s1fiflinitst, s1fifrinitst, 63 :: Unsigned 6, Straight, 0 :: Unsigned 6)

-- Initial state of stage 2
s2twfactors = $(v [
  ((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)) :: CFPConst  ])
s2butterflyL = mealy'  fftClock butterfly (s2twfactors, 127, 32 :: Index 128)

s2fiflinitst, s2fifrinitst :: Vec 32 CWord
(s2fiflinitst, s2fifrinitst) = (replicate d32 (0,0), replicate d32 (0,0))
s2commutatorL = mealy' fftClock commutator (s2fiflinitst, s2fifrinitst, 31 :: Unsigned 5, Straight, 0 :: Unsigned 5)

-- Initial state of stage 3
s3twfactors = $(v [
  ((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)) :: CFPConst  ])
s3butterflyL = mealy' fftClock butterfly (s3twfactors, 127, 16 :: Index 128)

s3fiflinitst, s3fifrinitst :: Vec 16 CWord
(s3fiflinitst, s3fifrinitst) = (replicate d16 (0,0), replicate d16 (0,0))
s3commutatorL = mealy' fftClock commutator (s3fiflinitst, s3fifrinitst, 15 :: Unsigned 4, Straight, 0 :: Unsigned 4)

-- Initial state of stage 4
s4twfactors = $(v [
  ((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((128553,17),(-25571,17)),((128553,17),(-25571,17)),((128553,17),(-25571,17)),((128553,17),(-25571,17)),((128553,17),(-25571,17)),((128553,17),(-25571,17)),((128553,17),(-25571,17)),((128553,17),(-25571,17)),((-25571,17),(-128553,17)),((-25571,17),(-128553,17)),((-25571,17),(-128553,17)),((-25571,17),(-128553,17)),((-25571,17),(-128553,17)),((-25571,17),(-128553,17)),((-25571,17),(-128553,17)),((-25571,17),(-128553,17)),((72820,17),(-108982,17)),((72820,17),(-108982,17)),((72820,17),(-108982,17)),((72820,17),(-108982,17)),((72820,17),(-108982,17)),((72820,17),(-108982,17)),((72820,17),(-108982,17)),((72820,17),(-108982,17)),((-108982,17),(-72820,17)),((-108982,17),(-72820,17)),((-108982,17),(-72820,17)),((-108982,17),(-72820,17)),((-108982,17),(-72820,17)),((-108982,17),(-72820,17)),((-108982,17),(-72820,17)),((-108982,17),(-72820,17)),((108982,17),(-72820,17)),((108982,17),(-72820,17)),((108982,17),(-72820,17)),((108982,17),(-72820,17)),((108982,17),(-72820,17)),((108982,17),(-72820,17)),((108982,17),(-72820,17)),((108982,17),(-72820,17)),((-72820,17),(-108982,17)),((-72820,17),(-108982,17)),((-72820,17),(-108982,17)),((-72820,17),(-108982,17)),((-72820,17),(-108982,17)),((-72820,17),(-108982,17)),((-72820,17),(-108982,17)),((-72820,17),(-108982,17)),((25571,17),(-128553,17)),((25571,17),(-128553,17)),((25571,17),(-128553,17)),((25571,17),(-128553,17)),((25571,17),(-128553,17)),((25571,17),(-128553,17)),((25571,17),(-128553,17)),((25571,17),(-128553,17)),((-128553,17),(-25571,17)),((-128553,17),(-25571,17)),((-128553,17),(-25571,17)),((-128553,17),(-25571,17)),((-128553,17),(-25571,17)),((-128553,17),(-25571,17)),((-128553,17),(-25571,17)),((-128553,17),(-25571,17)) :: CFPConst  ])
s4butterflyL = mealy' fftClock butterfly (s4twfactors, 127, 8 :: Index 128)

s4fiflinitst, s4fifrinitst :: Vec 8 CWord
(s4fiflinitst, s4fifrinitst) = (replicate d8 (0,0), replicate d8 (0,0))
s4commutatorL = mealy' fftClock commutator (s4fiflinitst, s4fifrinitst, 7 :: Unsigned 3, Straight, 0 :: Unsigned 3)

-- Initial state of stage 5
s5twfactors = $(v [
  ((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((1,0),(0,17)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((0,17),(-1,0)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((128553,17),(-25571,17)),((128553,17),(-25571,17)),((128553,17),(-25571,17)),((128553,17),(-25571,17)),((-25571,17),(-128553,17)),((-25571,17),(-128553,17)),((-25571,17),(-128553,17)),((-25571,17),(-128553,17)),((72820,17),(-108982,17)),((72820,17),(-108982,17)),((72820,17),(-108982,17)),((72820,17),(-108982,17)),((-108982,17),(-72820,17)),((-108982,17),(-72820,17)),((-108982,17),(-72820,17)),((-108982,17),(-72820,17)),((108982,17),(-72820,17)),((108982,17),(-72820,17)),((108982,17),(-72820,17)),((108982,17),(-72820,17)),((-72820,17),(-108982,17)),((-72820,17),(-108982,17)),((-72820,17),(-108982,17)),((-72820,17),(-108982,17)),((25571,17),(-128553,17)),((25571,17),(-128553,17)),((25571,17),(-128553,17)),((25571,17),(-128553,17)),((-128553,17),(-25571,17)),((-128553,17),(-25571,17)),((-128553,17),(-25571,17)),((-128553,17),(-25571,17)),((130441,17),(-12847,17)),((130441,17),(-12847,17)),((130441,17),(-12847,17)),((130441,17),(-12847,17)),((-12847,17),(-130441,17)),((-12847,17),(-130441,17)),((-12847,17),(-130441,17)),((-12847,17),(-130441,17)),((83151,17),(-101320,17)),((83151,17),(-101320,17)),((83151,17),(-101320,17)),((83151,17),(-101320,17)),((-101320,17),(-83151,17)),((-101320,17),(-83151,17)),((-101320,17),(-83151,17)),((-101320,17),(-83151,17)),((115595,17),(-61787,17)),((115595,17),(-61787,17)),((115595,17),(-61787,17)),((115595,17),(-61787,17)),((-61787,17),(-115595,17)),((-61787,17),(-115595,17)),((-61787,17),(-115595,17)),((-61787,17),(-115595,17)),((38048,17),(-125428,17)),((38048,17),(-125428,17)),((38048,17),(-125428,17)),((38048,17),(-125428,17)),((-125428,17),(-38048,17)),((-125428,17),(-38048,17)),((-125428,17),(-38048,17)),((-125428,17),(-38048,17)),((125428,17),(-38048,17)),((125428,17),(-38048,17)),((125428,17),(-38048,17)),((125428,17),(-38048,17)),((-38048,17),(-125428,17)),((-38048,17),(-125428,17)),((-38048,17),(-125428,17)),((-38048,17),(-125428,17)),((61787,17),(-115595,17)),((61787,17),(-115595,17)),((61787,17),(-115595,17)),((61787,17),(-115595,17)),((-115595,17),(-61787,17)),((-115595,17),(-61787,17)),((-115595,17),(-61787,17)),((-115595,17),(-61787,17)),((101320,17),(-83151,17)),((101320,17),(-83151,17)),((101320,17),(-83151,17)),((101320,17),(-83151,17)),((-83151,17),(-101320,17)),((-83151,17),(-101320,17)),((-83151,17),(-101320,17)),((-83151,17),(-101320,17)),((12847,17),(-130441,17)),((12847,17),(-130441,17)),((12847,17),(-130441,17)),((12847,17),(-130441,17)),((-130441,17),(-12847,17)),((-130441,17),(-12847,17)),((-130441,17),(-12847,17)),((-130441,17),(-12847,17)) :: CFPConst  ])
s5butterflyL = mealy'  fftClock butterfly (s5twfactors, 127, 4 :: Index 128)

s5fiflinitst, s5fifrinitst :: Vec 4 CWord
(s5fiflinitst, s5fifrinitst) = (replicate d4 (0,0), replicate d4 (0,0))
s5commutatorL = mealy' fftClock commutator (s5fiflinitst, s5fifrinitst, 3 :: Unsigned 2, Straight, 0 :: Unsigned 2)

-- Initial state of stage 6
s6twfactors = $(v [
  ((1,0),(0,17)),((1,0),(0,17)),((0,17),(-1,0)),((0,17),(-1,0)),((92682,17),(-92682,17)),((92682,17),(-92682,17)),((-92682,17),(-92682,17)),((-92682,17),(-92682,17)),((121095,17),(-50159,17)),((121095,17),(-50159,17)),((-50159,17),(-121095,17)),((-50159,17),(-121095,17)),((50159,17),(-121095,17)),((50159,17),(-121095,17)),((-121095,17),(-50159,17)),((-121095,17),(-50159,17)),((128553,17),(-25571,17)),((128553,17),(-25571,17)),((-25571,17),(-128553,17)),((-25571,17),(-128553,17)),((72820,17),(-108982,17)),((72820,17),(-108982,17)),((-108982,17),(-72820,17)),((-108982,17),(-72820,17)),((108982,17),(-72820,17)),((108982,17),(-72820,17)),((-72820,17),(-108982,17)),((-72820,17),(-108982,17)),((25571,17),(-128553,17)),((25571,17),(-128553,17)),((-128553,17),(-25571,17)),((-128553,17),(-25571,17)),((130441,17),(-12847,17)),((130441,17),(-12847,17)),((-12847,17),(-130441,17)),((-12847,17),(-130441,17)),((83151,17),(-101320,17)),((83151,17),(-101320,17)),((-101320,17),(-83151,17)),((-101320,17),(-83151,17)),((115595,17),(-61787,17)),((115595,17),(-61787,17)),((-61787,17),(-115595,17)),((-61787,17),(-115595,17)),((38048,17),(-125428,17)),((38048,17),(-125428,17)),((-125428,17),(-38048,17)),((-125428,17),(-38048,17)),((125428,17),(-38048,17)),((125428,17),(-38048,17)),((-38048,17),(-125428,17)),((-38048,17),(-125428,17)),((61787,17),(-115595,17)),((61787,17),(-115595,17)),((-115595,17),(-61787,17)),((-115595,17),(-61787,17)),((101320,17),(-83151,17)),((101320,17),(-83151,17)),((-83151,17),(-101320,17)),((-83151,17),(-101320,17)),((12847,17),(-130441,17)),((12847,17),(-130441,17)),((-130441,17),(-12847,17)),((-130441,17),(-12847,17)),((130914,17),(-6431,17)),((130914,17),(-6431,17)),((-6431,17),(-130914,17)),((-6431,17),(-130914,17)),((88023,17),(-97118,17)),((88023,17),(-97118,17)),((-97118,17),(-88023,17)),((-97118,17),(-88023,17)),((118488,17),(-56041,17)),((118488,17),(-56041,17)),((-56041,17),(-118488,17)),((-56041,17),(-118488,17)),((44157,17),(-123410,17)),((44157,17),(-123410,17)),((-123410,17),(-44157,17)),((-123410,17),(-44157,17)),((127144,17),(-31848,17)),((127144,17),(-31848,17)),((-31848,17),(-127144,17)),((-31848,17),(-127144,17)),((67384,17),(-112424,17)),((67384,17),(-112424,17)),((-112424,17),(-67384,17)),((-112424,17),(-67384,17)),((105278,17),(-78079,17)),((105278,17),(-78079,17)),((-78079,17),(-105278,17)),((-78079,17),(-105278,17)),((19232,17),(-129653,17)),((19232,17),(-129653,17)),((-129653,17),(-19232,17)),((-129653,17),(-19232,17)),((129653,17),(-19232,17)),((129653,17),(-19232,17)),((-19232,17),(-129653,17)),((-19232,17),(-129653,17)),((78079,17),(-105278,17)),((78079,17),(-105278,17)),((-105278,17),(-78079,17)),((-105278,17),(-78079,17)),((112424,17),(-67384,17)),((112424,17),(-67384,17)),((-67384,17),(-112424,17)),((-67384,17),(-112424,17)),((31848,17),(-127144,17)),((31848,17),(-127144,17)),((-127144,17),(-31848,17)),((-127144,17),(-31848,17)),((123410,17),(-44157,17)),((123410,17),(-44157,17)),((-44157,17),(-123410,17)),((-44157,17),(-123410,17)),((56041,17),(-118488,17)),((56041,17),(-118488,17)),((-118488,17),(-56041,17)),((-118488,17),(-56041,17)),((97118,17),(-88023,17)),((97118,17),(-88023,17)),((-88023,17),(-97118,17)),((-88023,17),(-97118,17)),((6431,17),(-130914,17)),((6431,17),(-130914,17)),((-130914,17),(-6431,17)),((-130914,17),(-6431,17)) :: CFPConst  ])
s6butterflyL = mealy' fftClock butterfly (s6twfactors, 127, 2 :: Index 128)

s6fiflinitst, s6fifrinitst :: Vec 2 CWord
(s6fiflinitst, s6fifrinitst) = (replicate d2 (0,0), replicate d2 (0,0))
s6commutatorL = mealy' fftClock commutator (s6fiflinitst, s6fifrinitst, 1 :: Unsigned 1, Straight, 0 :: Unsigned 1)

-- Initial state of stage 7
s7twfactors = $(v [
  ((1,0),(0,17)),((0,17),(-1,0)),((92682,17),(-92682,17)),((-92682,17),(-92682,17)),((121095,17),(-50159,17)),((-50159,17),(-121095,17)),((50159,17),(-121095,17)),((-121095,17),(-50159,17)),((128553,17),(-25571,17)),((-25571,17),(-128553,17)),((72820,17),(-108982,17)),((-108982,17),(-72820,17)),((108982,17),(-72820,17)),((-72820,17),(-108982,17)),((25571,17),(-128553,17)),((-128553,17),(-25571,17)),((130441,17),(-12847,17)),((-12847,17),(-130441,17)),((83151,17),(-101320,17)),((-101320,17),(-83151,17)),((115595,17),(-61787,17)),((-61787,17),(-115595,17)),((38048,17),(-125428,17)),((-125428,17),(-38048,17)),((125428,17),(-38048,17)),((-38048,17),(-125428,17)),((61787,17),(-115595,17)),((-115595,17),(-61787,17)),((101320,17),(-83151,17)),((-83151,17),(-101320,17)),((12847,17),(-130441,17)),((-130441,17),(-12847,17)),((130914,17),(-6431,17)),((-6431,17),(-130914,17)),((88023,17),(-97118,17)),((-97118,17),(-88023,17)),((118488,17),(-56041,17)),((-56041,17),(-118488,17)),((44157,17),(-123410,17)),((-123410,17),(-44157,17)),((127144,17),(-31848,17)),((-31848,17),(-127144,17)),((67384,17),(-112424,17)),((-112424,17),(-67384,17)),((105278,17),(-78079,17)),((-78079,17),(-105278,17)),((19232,17),(-129653,17)),((-129653,17),(-19232,17)),((129653,17),(-19232,17)),((-19232,17),(-129653,17)),((78079,17),(-105278,17)),((-105278,17),(-78079,17)),((112424,17),(-67384,17)),((-67384,17),(-112424,17)),((31848,17),(-127144,17)),((-127144,17),(-31848,17)),((123410,17),(-44157,17)),((-44157,17),(-123410,17)),((56041,17),(-118488,17)),((-118488,17),(-56041,17)),((97118,17),(-88023,17)),((-88023,17),(-97118,17)),((6431,17),(-130914,17)),((-130914,17),(-6431,17)),((131033,17),(-3217,17)),((-3217,17),(-131033,17)),((90379,17),(-94929,17)),((-94929,17),(-90379,17)),((119827,17),(-53116,17)),((-53116,17),(-119827,17)),((47172,17),(-122289,17)),((-122289,17),(-47172,17)),((127887,17),(-28718,17)),((-28718,17),(-127887,17)),((70123,17),(-110737,17)),((-110737,17),(-70123,17)),((107162,17),(-75472,17)),((-75472,17),(-107162,17)),((22408,17),(-129142,17)),((-129142,17),(-22408,17)),((130086,17),(-16045,17)),((-16045,17),(-130086,17)),((80640,17),(-103330,17)),((-103330,17),(-80640,17)),((114044,17),(-64605,17)),((-64605,17),(-114044,17)),((34959,17),(-126324,17)),((-126324,17),(-34959,17)),((124457,17),(-41115,17)),((-41115,17),(-124457,17)),((58931,17),(-117077,17)),((-117077,17),(-58931,17)),((99249,17),(-85613,17)),((-85613,17),(-99249,17)),((9642,17),(-130717,17)),((-130717,17),(-9642,17)),((130717,17),(-9642,17)),((-9642,17),(-130717,17)),((85613,17),(-99249,17)),((-99249,17),(-85613,17)),((117077,17),(-58931,17)),((-58931,17),(-117077,17)),((41115,17),(-124457,17)),((-124457,17),(-41115,17)),((126324,17),(-34959,17)),((-34959,17),(-126324,17)),((64605,17),(-114044,17)),((-114044,17),(-64605,17)),((103330,17),(-80640,17)),((-80640,17),(-103330,17)),((16045,17),(-130086,17)),((-130086,17),(-16045,17)),((129142,17),(-22408,17)),((-22408,17),(-129142,17)),((75472,17),(-107162,17)),((-107162,17),(-75472,17)),((110737,17),(-70123,17)),((-70123,17),(-110737,17)),((28718,17),(-127887,17)),((-127887,17),(-28718,17)),((122289,17),(-47172,17)),((-47172,17),(-122289,17)),((53116,17),(-119827,17)),((-119827,17),(-53116,17)),((94929,17),(-90379,17)),((-90379,17),(-94929,17)),((3217,17),(-131033,17)),((-131033,17),(-3217,17)) :: CFPConst  ])
s7butterflyL = mealy' fftClock butterfly (s7twfactors, 127, 1 :: Index 128)

s7fiflinitst, s7fifrinitst :: Vec 1 CWord
(s7fiflinitst, s7fifrinitst) = (replicate d1 (0,0), replicate d1 (0,0))
s7commutatorL = mealy' fftClock commutator (s7fiflinitst, s7fifrinitst, 0 :: Unsigned 1, Straight, 0 :: Unsigned 1)

-- The last stage performs the calculation of the magnitude squared
slastL = mealy' fftClock magsqrdaddr (1, False)

-- The first stage synchronises with the rising edge of the valid bitrev
sfirstL = mealy' fftClock valsampler 0

-- The output register
soutregL = mealy' fftClock outreg (0, 0, False)

-- Arrows for the different stages
fftstage0 = s0commutatorL >>> s0butterflyL
fftstage1 = s1commutatorL >>> s1butterflyL
fftstage2 = s2commutatorL >>> s2butterflyL
fftstage3 = s3commutatorL >>> s3butterflyL
fftstage4 = s4commutatorL >>> s4butterflyL
fftstage5 = s5commutatorL >>> s5butterflyL
fftstage6 = s6commutatorL >>> s6butterflyL
fftstage7 = s7commutatorL >>> s7butterflyL

fftfull = sfirstL >>> fftstage0 >>> fftstage1 >>> fftstage2 >>> fftstage3 >>> fftstage4 >>> fftstage5 >>> fftstage6 >>> fftstage7 >>> slastL >>> soutregL

-- A not so elegant way of performing the bitreversal
bitrev :: Binaddr -> Binaddr
bitrev val = valr
  where b0 = ((val `shiftL` 0 ) `shiftR` 6) `shiftL` 0
        b1 = ((val `shiftL` 1 ) `shiftR` 6) `shiftL` 1
        b2 = ((val `shiftL` 2 ) `shiftR` 6) `shiftL` 2
        b3 = ((val `shiftL` 3 ) `shiftR` 6) `shiftL` 3
        b4 = ((val `shiftL` 4 ) `shiftR` 6) `shiftL` 4
        b5 = ((val `shiftL` 5 ) `shiftR` 6) `shiftL` 5
        b6 = ((val `shiftL` 6 ) `shiftR` 6) `shiftL` 6
        valr = b0 + b1 + b2 + b3 + b4 + b5 + b6
